---
title: "Stat3_Les08_FS_v4"
author: "Emile Apol"
date: "10-3-2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


###############################################################################
#
# Statistiek 3 BIN
#
# 2019-2020
#
# Emile Apol 
#
# Les 08 - Differentially Expressed Genes (DEGs) 1
#
###############################################################################



###############################################################################
#
# Voorbeeld 8.1 - Gewicht van kuikens
#
###############################################################################

In de R dataset "chickwts" staan de gewichten (variabele "weight") van kuikens van 6 weken (in eenheden van 10 gram) als functie van een aantal soorten voedings-supplement (variabele "feed").


```{r}
data(chickwts)
head(chickwts)
str(chickwts)
attach(chickwts)
```

a) Maak een (box)plot van weight als functie van feed. NB. Via de optie par(las=2) in plot kun je de labels langs de assen allemaal loodrecht op de assen zetten.

```{r}
boxplot(weight ~ feed, xlab = "Feed", ylab = "Chicken weight (x 10 g)", las=2)
```

b) Voer in R een 1-way ANOVA uit om te onderzoeken of het gewicht na 6 week (weight) significant wordt be√Ønvloed door het soort voedingssupplement (feed). Toets met alpha = 0.05.

```{r}
( res <- summary(aov(weight ~ feed)) )
```
p = 5.94e-10 << 0.05 = alpha, dus H1: Het gewicht wordt significant beinvloed door het type voeding.


c) Voer een (Fisher) LSD post-hoc test uit (d.w.z. paarsgewijze t-toetsen zonder correctie!) om te zien welke soorten voeding significant verschillende gewichten opleveren. Toets met alpha = 0.05. Welke ‚Äúhomogene subsets‚Äù zijn er, d.w.z. welke sets van feed geven hetzelfde gewicht? Je kunt gebruik maken van de functie "postHocHomSubsets" in de file "Homogeneous_subsets_v1".

```{r}
source("Homogeneous_subsets_v1.r")
postHocHomSubsets(weight, feed, p.adjust.method = "none", alpha = 0.05)
```
Dus: {Horsebean} < {Linseed, Soybean} < {Soybean, Meatmeal} < {Casein, Sunflower}


d) Voer ook een Tukey HSD post-hoc test uit om te zien welke soorten voeding significant verschillende gewichten opleveren. Toets met alpha = 0.05. Welke ‚Äúhomogene subsets‚Äù zijn er?

```{r}
postHocHomSubsets(weigLht, feed, p.adjust.method = "tukey", alpha = 0.05)
```
Dus: {Horsebean, Linseed} < {Linseed, Soybean, Meatmeal} < {Meatmeal, Casein, Sunflower}

e) Voer tenslotte ook een Bonferroni post-hoc test uit om te zien welke soorten voeding significant verschillende gewichten opleveren. Toets met alpha = 0.05. Welke ‚Äúsubsets‚Äù zijn er?

```{r}
postHocHomSubsets(weight, feed, p.adjust.method = "bonferroni", alpha = 0.05)
```
Dus: {Horsebean, Linseed} < {Linseed, Soybean, Meatmeal} < {Meatmeal, Casein, Sunflower}

f) Vergelijk de p-waarden die uit de 3 methoden komen (Fisher LSD, Tukey HSD, Bonferroni). Vergelijk de verschillende ‚Äúsubsets‚Äù van feed ook met de boxplot uit opgave a.

Bonferroni en Tukey geven dezelfde clustering, en vergelijkbare p-waarden.




###############################################################################
#
# Voorbeeld 8.2 - Differentiele genexpressie (1)
#
###############################################################################

We willen graag weten welke genen differentieel tot expressie komen bij een bepaalde vorm van kanker. Bij twee samples (controle en kankercellen) is mRNA ge√Øsoleerd. Beide samples worden m.b.v. een 2-channel microarray experiment geanalyseerd (R = kanker, G = controle), met 5 replica‚Äôs (= 5 verschillende array‚Äôs) met elk spots voor 100 genen. De data zijn op een juiste manier gepreprocessed: d.w.z. background correctie, normalisatie en logtransformatie, met als resultaat de log expressie ratio

        M_(g,i) = log2(R_(g,i)) - log2(G_(g,i)) = log2(R_(g,i) / G_g,i))

voor gen g (= 1 t/m 100) en replica i (= 1 t/m 5). In de file DEG_1.txt zijn per gen de resultaten van de 5 replica‚Äôs verzameld.

a) Lees in R deze data in als dataframe genes1, en houd rekening met het feit dat in de text file rij- en kolomnamen staan, en tab de field separator is:
        read.table(‚ÄúDEG_1.txt‚Äù, sep = ‚Äù\t‚Äù, header = T)
Print de vector met rijnamen en de vector met kolomnamen.

```{r}
setwd("E:/Hanze/ILST/vakken/kwartaal 07/Statistiek 3 BIN/lessen/2019-2020/Les 08 - DEG 1/")
genes1 <- read.table("DEG_1.txt", header = T, sep = "\t")
head(genes1)
( gene.names <- rownames(genes1) )
( samples <- colnames(genes1) )

```

b) Voer per gen (= rij van genes1) een 1-sample t-toets uit om te kijken of er sprake is van differenti√´le expressie, d.w.z. of de gemiddelde log expressie ratio significant anders is dan 0. Gebruik de functie apply en een zelfgemaakte t-toets functie. Verzamel alle p-waarden in een vector pVec. Geef aan hoeveel en welke genen differentieel tot expressie komen. Toets met alpha = 0.05 en voer g√©√©n multiple-toetsingscorrectie uit.

```{r}
myTTest <- function(y, mu){
  return(t.test(y, mu=mu)$p.value)
}

cat("p-waarden:\n")
( pVec <- apply(genes1, 1, myTTest, mu = 0) )
alpha <- 0.05
cat("p-values DEGs:\n")
pVec[pVec < alpha]
cat("DEGs:\n")
( DEG <- gene.names[pVec < alpha])
cat("Number of DEGs:\n")
( n.DEG <- sum(pVec < alpha) )
```
Er zijn dus 5 significante genen: gen 35, 36, 71, 81 en 84.



De waarden in de file DEG_1.txt zijn gemaakt als 500 random normaalverdeelde waarden met mu = 0 en sigma = 2.5. Er zijn dus in het echt GEEN genen die differenti√´el tot expressie komen.

c) Leg uit waarom je bij b. toch een aantal significante genen vindt.

Dit zijn vals positive uitslagen. Je verwacht 100 * 0.05 = 5 FP genen.



Er zijn verschillende multiple-toetsingscorrecties die je in R kunt gebruiken, zoals de Bonferroni en Holm (= Holm-Bonferroni) en False Discovery Rate (FDR) methoden.

d) Voer op de p-waarden (pVec) een Bonferroni correctie uit met alpha = 0.05. Geef aan hoeveel en welke genen differentieel tot expressie komen.

```{r}
cat("Adjusted p-values:\n")
( pVec.Bon <- p.adjust(pVec, method = "bonferroni") )
cat("Number of real DEGs using Bonferroni correction:\n")
( n.DEG.Bon <- sum(pVec.Bon < alpha) )
```

Er zijn dus geen (0) DEGs na Bonferroni correctie.


e) Voer op de p-waarden (pVec) een Holm correctie uit met alpha = 0.05. Geef aan hoeveel en welke genen differentieel tot expressie komen.

```{r}
cat("Adjusted p-values:\n")
( pVec.Holm <- p.adjust(pVec, method = "holm") )
cat("Number of real DEGs using Holm correction:\n")
( n.DEG.Holm <- sum(pVec.Holm < alpha) )
```

Er zijn dus geen (0) DEGs na Holm correctie.



f) Voer op de p-waarden (pVec) een FDR correctie uit met alpha = 0.05. Geef aan hoeveel en welke genen differentieel tot expressie komen.

```{r}
cat("Adjusted p-values:\n")
( pVec.FDR <- p.adjust(pVec, method = "fdr") )
cat("Number of real DEGs using FDR correction:\n")
( n.DEG.FDR <- sum(pVec.FDR < alpha) )
```

Er zijn dus geen (0) DEGs na FDR correctie.


In de file DEG_2.txt staan de resultaten van 10 000 genen, waarvan er in het echt geen enkele differentieel tot expressie komt.

g) Lees de data in als dataframe "genes2", en bereken de vector met p-waarden voor de ongecorrigeerde 1-sample t-toetsen. Geef aan hoeveel genen differentieel tot expressie komen. Klopt dit met wat je verwacht als aantal vals positieven? 

```{r}
genes2 <- read.table("DEG_2.txt", header = T, sep = "\t")
head(genes2)
gene.names <- rownames(genes2)
head(gene.names)
( samples <- colnames(genes2) )
```

h) Voer nu opnieuw de Bonferroni, de Holm en de FDR correcties uit op deze ùëùùëù-waarden. Hoeveel genen zijn er nu bij deze drie methoden significant?

```{r}
alpha <- 0.05
cat("No correction:\n")
pVec <- apply(genes1, 1, myTTest, mu = 0)
( n.DEG <- sum(pVec < alpha) )

cat("Bonferroni correction:\n")
pVec.Bon <- p.adjust(pVec, method = "bonferroni")
( n.DEG.Bon <- sum(pVec.Bon < alpha) )

cat("Holm correction:\n")
pVec.Holm <- p.adjust(pVec, method = "holm")
( n.DEG.Holm <- sum(pVec.Holm < alpha) )

cat("FDR correction:\n")
pVec.FDR <- p.adjust(pVec, method = "fdr")
( n.DEG.FDR <- sum(pVec.FDR < alpha) )
```




###############################################################################
#
# Voorbeeld 8.3 - Differentiele genexpressie (2)
#
###############################################################################


In een 2-channel microarray experiment met 5 replica‚Äôs (i = 1..5), zoals beschreven in Voorbeeld 8.2, wordt gekeken of er bepaalde genen differentieel tot expressie komen, als je kankercellen en gezonde cellen vergelijkt. De gecorrigeerde, log-getransformeerde R- en G-waarden staan per gen g (1 t/m 100) als volgt in de ascii file DEG_3.txt met tabs als scheiding.

a) Lees in R deze data in als dataframe "genes3", en bekijk de structuur van dit dataframe.

```{r}
setwd("E:/Hanze/ILST/vakken/kwartaal 07/Statistiek 3 BIN/lessen/2019-2020/Les 08 - DEG 1/")
genes3 <- read.table("DEG_3.txt", header = T, sep = "\t")
head(genes3)
( gene.names <- rownames(genes3) )
( samples <- colnames(genes3) )
```


b) Bereken voor elke replica een vector met de M_(g,i) = log2(R_(g,i)/G_(g,i)) = log2(R_(g,i)) - log(G_(g,i)) waarden, en combineer deze kolommen tot een nieuw dataframe genes4. Zorg voor juiste rij- en kolomnamen.

```{r}
( Rcols <- samples[1:5] )
( Gcols <- samples[6:10] )
logR <- as.vector(as.matrix(genes3[, Rcols]))
logG <- as.vector(as.matrix(genes3[, Gcols]))
logM <- logR - logG
n.replica <- length(Rcols)
genes4 <- data.frame(matrix(logM, ncol = n.replica), row.names = gene.names)
colnames(genes4) <- paste0(rep("M.",n.replica),1:(n.replica))

head(genes4)
```


c) Voer op genes4 per gen (= rij) een 1-sample t-toets uit om te zien welke genen differentieel tot expressie komen. Verzamel de p-waarden in een vector. Gebruik de functie apply en een zelfgemaakte functie om de p-waarde van een 1-sample t-toets per rij van een matrix te berekenen (zie Voorbeeld 8.2.b). Hoeveel en welke genen zijn significant? Toets met alpha = 0.05 zonder multiple testing correctie.

```{r}
myTTest <- function(y, mu){
  return(t.test(y, mu=mu)$p.value)
}

cat("p-waarden:\n")
( pVec <- apply(genes4, 1, myTTest, mu = 0) )
alpha <- 0.05

cat("\nSignificant genes: ", gene.names[pVec < alpha], "\n")
cat("Number of Significant genes = ", sum(pVec < alpha), "\n")
```


d) Corrigeer deze vector met p-waarden m.b.v. de Bonferroni en Holm methode. Hoeveel en welke genen zijn nu significant? Toets met alpha.F = 0.05.

```{r}
cat("Bonferroni correction:\n")
pVec.Bon <- p.adjust(pVec, method = "bonferroni")
cat("DEGs: ", gene.names[pVec.Bon < alpha], "\n")
n.DEG.Bon <- sum(pVec.Bon < alpha)
cat("Number of DEGs = ", n.DEG.Bon,"\n\n")

cat("Holm correction:\n")
pVec.Holm <- p.adjust(pVec, method = "holm")
cat("DEGs: ", gene.names[pVec.Holm < alpha], "\n")
n.DEG.Holm <- sum(pVec.Holm < alpha)
cat("Number of DEGs = ", n.DEG.Holm,"\n")
```


e) Programmeer in R een eigen functie die voor een rij (= gen) van dataframe genes3 de p-waarde van een gepaarde t-toets berekent. Tip: het aantal paren is de helft van de rijlengte.

```{r}
myPairedTTest <- function(x){
  n.elem <- length(x)
  n.pairs <- n.elem / 2 # half of the length
  # make a factor with groups
  mySample <- factor(c(rep(1, n.pairs), rep(2, n.pairs)))
  t.test(x ~ mySample, paired=T)$p.value  
}
```

f) Voer op genes3 per gen (= rij) een gepaarde t-toets uit om te zien welke genen differentieel tot expressie komen. Verzamel de p-waarden in een vector. Gebruik de functie apply en de zelfgemaakte functie van e. om de p-waarde van een gepaarde t-toets per rij van een matrix te berekenen. Gebruik geen multiple testing correctie. Hoeveel en welke genen zijn significant? Toets met alpha.F = 0.05.

```{r}
( pVec2 <- apply(genes3, 1, myPairedTTest) )

alpha <- 0.05

cat("\nSignificant genes: ", gene.names[pVec2 < alpha], "\n")
cat("Number of Significant genes = ", sum(pVec2 < alpha), "\n")

```


g) Corrigeer deze vector met p-waarden m.b.v. de Bonferroni en Holm methode. Hoeveel en welke genen zijn nu significant? Toets met alpha.F = 0.05.

```{r}
cat("Bonferroni correction:\n")
pVec.Bon <- p.adjust(pVec2, method = "bonferroni")
cat("DEGs: ", gene.names[pVec.Bon < alpha], "\n")
n.DEG.Bon <- sum(pVec.Bon < alpha)
cat("Number of DEGs = ", n.DEG.Bon,"\n\n")

cat("Holm correction:\n")
pVec.Holm <- p.adjust(pVec2, method = "holm")
cat("DEGs: ", gene.names[pVec.Holm < alpha], "\n")
n.DEG.Holm <- sum(pVec.Holm < alpha)
cat("Number of DEGs = ", n.DEG.Holm,"\n")
```













